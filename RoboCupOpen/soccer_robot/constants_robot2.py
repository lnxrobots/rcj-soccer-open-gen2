import math
import logging
from . import camera_configs
from soccer_robot.utils.camera import Camera
from soccer_robot.mathf.vector2 import Vector2

CALIBRATION_FILE = "calibration.json"

# ModuleManager
MODULEMANAGER_MAX_TERM_TIME = 2

# Interfaces
FRONT_CAMERA = Camera(
    port=0,
    camera_config=camera_configs.ARDUCAM_B0310,
    mount_config=camera_configs.GEN2_FRONT_MOUNT,
    slot_bounding_box=(0.5, 0.85, 0.2, 0.2),
)
MIRROR_CAMERA = Camera(
    port=1,
    camera_config=camera_configs.ARDUCAM_B0262,
    mount_config=camera_configs.MIRROR_MOUNT,
    mirror=camera_configs.VINDIS_VACUUM_MIRROR,
    mirror_center=(1173/2322, 954/1742), # (2040/4056, 1700/3040) for original lens
    mirror_radius=1173/2322, # 1874/4056 for original lens
    min_ball_size=(0.005, 0.005)
)
# VISION_FRONT_ALWAYS_ON = False
FRONT_CHECK_TIME = 100
FRONT_STAY_TIME = 100

UNDERCARRIAGE_SERIAL_PORT = "/dev/ttyAMA0"
UNDERCARRIAGE_BOUD_RATE = 230400 #115200
SENSOR_ANGLES = [ # Angles of sensors from front center, clockwise
    57, 96.3, 134.6, 180,
    225.4, 263.7, 303, 0,
    0, 0, 0, 0,
    0, 0, 0, 0
]
SENSOR_MAX_DIST = 36
SENSOR_DIST = [30, 36, 28.7, 36, 28.7, 36, 30] # Distances from center
KICK_START_TIME = 0
KICK_TIME = 100

UI_MAX_STATUS = 24

BUTTON_MOTORS_PIN = 10
BUTTON_MOTORS_BOUNCE = None

# Logging
LOGGER_MAX_QUEUE_SIZE = 10
LOGGER_LOGS_PATH = "."
LOGGER_CONSOLE_LOGLEVEL = logging.INFO
LOGGER_FILE_LOGLEVEL = logging.DEBUG

# Visualization
VISUALIZER_PORT = 8765
VISUALIZER_MESSAGE_INTERVAL = 0.06
VISUALIZE_IMAGE_WIDTH = 576
VISUALIZE_IMAGE_HEIGHT = 324

# Communication
BTH_SERVER_INDEX = 0
BTH_POWERUP_ADAPTER = True
BTH_MESSAGE_INTERVAL = 60
BTH_RECONNECT_INTERVAL = 1000

# Robot
ROBOT_PRECISE_BALL_MOVE = False
ROBOT_DEFEND = True

ROBOT_SPIN_OFFSET_SMALL = 0 ##FIXME na kruzku 23.6 zmenene na 0.015
ROBOT_SPIN_OFFSET_BIG = 0 ##FIXME na kruzku 23.6 zmenene na 0.025

ROBOT_BACKWARDS_TIME = 1000
ROBOT_WHEEL_D = 60
ROBOT_WHEEL_DISTANCE = 85
ROBOT_MAX_SPEED = 2000

MOTOR_CONF = 1
MOTOR_SPEED_TO_RPM = 1
MOTOR_SPEED_RANGE = 1000
MOTOR_ANGLES = [57.5, 135, 225, 302.5]

# LINE_AVOID_FAST_THRES = 90
# LINE_AVOID_FAST = 700
# LINE_AVOID_SLOW = 350
# #LINE_AVOID_SPEED = ROBOT_SPEED
# LINE_AVOID_ANTIVECTOR = 1.8

BALL_TARGET_DISTANCE = 260
BALL_DIAMETER = 42
GOAL_REAL_SIZE = (600, 120) # Resize to 100 before competition!!! # Resize to 120 after competiton!!!!
GOAL_POSITION = (0, 1100)
GOAL_HEIGHT_SAMPLE = 1/4

BALL_FINDING_ROTATE_TIME = 300
BALL_FINDING_WAIT_TIME = 150

SPIN_MAX_SPEED_ANGLE = 80

SPIN_SHOOTPOS_SPEED = 0.14 # when going to shooting position
SPIN_BALL_SPEED = 0.19 # when going from shooting position to ball
SPIN_GOAL_SPEED = 0.13 ##FIXME na kruzku 23.6 zmenene na 0.3  # when going from ball to goal
SPIN_BACKWARDS_SPEED = 0.18 # when going backwards to find a ball
SPIN_GET_AROUND_SPEED = 0.13 # when getting around ball

WATCHING_ANGLES = [0, 30, 50, 120, 180]
WATCHING_SPINS = [0, 20, 200, 400, 400]

TURNING_BALL_ANGLES = [0, 1, 3, 6]
TURNING_BALL_SPINS = [0, 150, 200, 200]
TURNING_BALL_RADIUS = 120

BALL_CHASING_WATCH_TRESHOLD = 45 # deg
BALL_CHASING_DISTS = [0, 70, 120, 500, math.inf]
BALL_CHASING_SPEEDS = [100, 350, 350, 1500, 1500]
BALL_CHASING_SPINS = [100, 30, 100, 100, 100]
BALL_CHASING_STOP_DIST = 80

DRIBBLER_CATCH_TOLERANCE = (50, 25) # mm, deg
DRIBBLER_CATCH_SPEED = 150
DRIBBLER_SPEED = 400

SHOOT_SPEED_TURNING = 500
SHOOT_SPEED = 1000
SHOOT_SPEED_TIME = 500

BALL_LOST_TIMEOUT = 100
BALL_POS_HISTORY_TIME = 500

GET_AROUND_ANGLE = 30
GET_AROUND_MIN_DIST = 180
GET_AROUND_MAX_DIST = 330

GET_AROUND_MID_DIST = 250
GET_AROUND_MIN_SPEED_MULT = 0.8
GET_AROUND_MAX_BALL_ANGLE = 35
GET_AROUND_ROTATE_SPEED = 60

GOALIE_MASTER_INDEX = 0
GOALIE_CHANGE_TIME = 2000
BACK_OFF_SECTOR = 7
BACK_OFF_OK_SECTORS = [6, 7, 8]
BACK_OFF_SPIN = 0.6

FIELD_SIZE = Vector2(1820, 2430)

TRACKER_GOAL_SPOT_R = 700
TRACKER_MIN_MOVE = 700
TRACKER_LINE_ADDEND = 0.01
TRACKER_LINE_MULTIPLIER = 1.2

SIDE_SECTOR_WIDTH = 500

AROUND_BALL_DIST_FRONT = 180
AROUND_BALL_DIST_MIRROR = 300
APPROACH_BALL_DIST_FRONT = 400
APPROACH_BALL_DIST_MIRROR = 500
APPROACH_BALL_DIST_FRONT_QUIT = 500
APPROACH_BALL_DIST_MIRROR_QUIT = 600
CAPTURE_BALL_ANGLE = 20 #30
CAPTURE_BALL_ANGLE_QUIT = 30 #should be higher than capture ball angle

AVOID_LINE_TIME = 400
AVOID_LINE_SPEED = 200

MOTOR_MULTIPLIERS = [1, 1, 1, 1]
